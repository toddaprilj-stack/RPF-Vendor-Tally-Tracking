<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Tally Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1a202c;
            margin-bottom: 8px;
            font-size: 28px;
        }

        h2 {
            color: #2d3748;
            margin-bottom: 16px;
            font-size: 22px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 24px;
        }

        .balance-display {
            font-size: 48px;
            font-weight: bold;
            margin: 24px 0;
            text-align: center;
        }

        .balance-positive {
            color: #48bb78;
        }

        .balance-negative {
            color: #f56565;
        }

        .balance-zero {
            color: #4299e1;
        }

        .balance-label {
            font-size: 14px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-align: center;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            margin-top: 12px;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-danger {
            background: #f56565;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            color: #2d3748;
            font-weight: 500;
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .vendor-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .vendor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .vendor-name {
            font-size: 20px;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 12px;
        }

        .vendor-balance {
            font-size: 24px;
            font-weight: bold;
            margin: 12px 0;
        }

        .vendor-info {
            font-size: 14px;
            color: #718096;
            margin: 4px 0;
        }

        .sales-history {
            margin-top: 24px;
        }

        .sales-entry {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
        }

        .sales-entry:last-child {
            border-bottom: none;
        }

        .sales-date {
            color: #718096;
            font-size: 14px;
        }

        .sales-amount {
            font-weight: bold;
            color: #2d3748;
        }

        .sales-commission {
            color: #f56565;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .link-display {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
        }

        .copy-btn {
            background: #48bb78;
            margin-top: 8px;
        }

        .copy-btn:hover {
            background: #38a169;
        }

        @media (max-width: 768px) {
            .vendor-grid {
                grid-template-columns: 1fr;
            }
            
            .balance-display {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin View -->
        <div id="adminView" class="hidden">
            <div class="card">
                <h1>Admin Dashboard</h1>
                <p class="subtitle">Manage all vendor accounts and tallies</p>
                <button class="btn" onclick="showAddVendorModal()">+ Add New Vendor</button>
                <button class="btn btn-secondary" onclick="exportData()">Export All Data</button>
            </div>

            <div id="vendorsList" class="vendor-grid"></div>
        </div>

        <!-- Vendor View -->
        <div id="vendorView" class="hidden">
            <div class="card">
                <h1 id="vendorName"></h1>
                <p class="subtitle" id="vendorEmail"></p>
                
                <div class="balance-label">Current Balance</div>
                <div class="balance-display" id="vendorBalance">$0.00</div>
                
                <button class="btn" onclick="showAddSalesModal()">+ Add Weekend Sales</button>
            </div>

            <div class="card sales-history">
                <h2>Sales History</h2>
                <div id="salesHistoryList"></div>
            </div>
        </div>

        <!-- Loading View -->
        <div id="loadingView" class="card">
            <div class="loading">Loading...</div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="hidden">
            <div class="card">
                <h1>Vendor Tally Tracker</h1>
                <p class="subtitle">Enter admin password to access dashboard</p>
                <div class="form-group">
                    <label>Admin Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter password">
                </div>
                <button class="btn" onclick="adminLogin()">Login</button>
            </div>
        </div>
    </div>

    <!-- Add Vendor Modal -->
    <div id="addVendorModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('addVendorModal')">&times;</span>
            <h2>Add New Vendor</h2>
            <div class="form-group">
                <label>Vendor Name</label>
                <input type="text" id="newVendorName" placeholder="John's Booth">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="newVendorEmail" placeholder="john@example.com">
            </div>
            <div class="form-group">
                <label>Prepayment Amount ($)</label>
                <input type="number" id="newVendorPrepayment" placeholder="500" step="0.01">
            </div>
            <div class="form-group">
                <label>Tally Rate (%)</label>
                <input type="number" id="newVendorCommission" placeholder="15" step="0.01">
            </div>
            <button class="btn" onclick="createVendor()" id="createVendorBtn">Create Vendor</button>
            <div id="vendorLinkDisplay" class="hidden">
                <h3 style="margin-top: 20px;">Vendor Link Created!</h3>
                <div class="link-display" id="generatedLink"></div>
                <button class="btn copy-btn" onclick="copyVendorLink()">Copy Link</button>
            </div>
        </div>
    </div>

    <!-- Add Sales Modal -->
    <div id="addSalesModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('addSalesModal')">&times;</span>
            <h2>Add Weekend Sales</h2>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="salesDate">
            </div>
            <div class="form-group">
                <label>Gross Sales ($)</label>
                <input type="number" id="salesAmount" placeholder="0.00" step="0.01">
            </div>
            <button class="btn" onclick="addSales()" id="addSalesBtn">Submit Sales</button>
        </div>
    </div>

    <!-- Edit Vendor Modal -->
    <div id="editVendorModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('editVendorModal')">&times;</span>
            <h2>Edit Vendor</h2>
            <input type="hidden" id="editVendorId">
            <div class="form-group">
                <label>Vendor Name</label>
                <input type="text" id="editVendorName">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editVendorEmail">
            </div>
            <div class="form-group">
                <label>Prepayment Amount ($)</label>
                <input type="number" id="editVendorPrepayment" step="0.01">
            </div>
            <div class="form-group">
                <label>Tally Rate (%)</label>
                <input type="number" id="editVendorCommission" step="0.01">
            </div>
            <button class="btn" onclick="updateVendor()">Update Vendor</button>
            <button class="btn btn-danger" onclick="deleteVendor()">Delete Vendor</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
const ADMIN_PASSWORD = 'admin123';
let currentView = 'loading';
let currentVendorId = null;
let isAdmin = false;
let db;
let appData = {
    vendors: {},
    sales: {}
};

// Initialize Firebase when scripts are loaded
setTimeout(function() {
    try {
        const firebaseConfig = {
            apiKey: "AIzaSyD5I3M297ePu8VNc1ZoKXOsb4YOCnNqll0",
            authDomain: "vendor-tally-tracker.firebaseapp.com",
            projectId: "vendor-tally-tracker",
            storageBucket: "vendor-tally-tracker.firebasestorage.app",
            messagingSenderId: "202965964560",
            appId: "1:202965964560:web:f779558f5f777702777795"
        };

        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        window.db = db;
        
        init();
    } catch (error) {
        console.error('Firebase initialization error:', error);
        alert('Error loading app. Please refresh the page.');
    }
}, 1000);

async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const vendorId = urlParams.get('v');
    
    if (vendorId) {
        await loadVendorView(vendorId);
    } else {
        showView('loginView');
    }
}

function showView(viewId) {
    ['adminView', 'vendorView', 'loadingView', 'loginView'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(viewId).classList.remove('hidden');
    currentView = viewId;
}

function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        loadAdminView();
    } else {
        alert('Incorrect password');
    }
}

async function loadAdminView() {
    showView('adminView');
    await loadAllData();
    renderVendorsList();
    
    db.collection('vendors').onSnapshot(() => {
        loadAllData().then(() => renderVendorsList());
    });
}

async function loadAllData() {
    const vendorsSnap = await db.collection('vendors').get();
    appData.vendors = {};
    vendorsSnap.forEach(doc => {
        appData.vendors[doc.id] = { id: doc.id, ...doc.data() };
    });
    
    const salesSnap = await db.collection('sales').get();
    appData.sales = {};
    salesSnap.forEach(doc => {
        appData.sales[doc.id] = { id: doc.id, ...doc.data() };
    });
}

function renderVendorsList() {
    const container = document.getElementById('vendorsList');
    container.innerHTML = '';
    
    if (Object.keys(appData.vendors).length === 0) {
        container.innerHTML = '<div class="card"><p style="text-align: center; color: #718096;">No vendors yet. Click "Add New Vendor" to get started.</p></div>';
        return;
    }
    
    Object.entries(appData.vendors).forEach(([id, vendor]) => {
        const balance = calculateVendorBalance(id);
        const balanceClass = balance > 0 ? 'balance-positive' : balance < 0 ? 'balance-negative' : 'balance-zero';
        
        const card = document.createElement('div');
        card.className = 'vendor-card';
        card.innerHTML = `
            <div class="vendor-name">${vendor.name}</div>
            <div class="vendor-info">${vendor.email}</div>
            <div class="vendor-balance ${balanceClass}">$${balance.toFixed(2)}</div>
            <div class="vendor-info">Prepayment: $${vendor.prepayment.toFixed(2)}</div>
            <div class="vendor-info">Tally: ${vendor.commissionRate}%</div>
            <button class="btn btn-secondary" onclick="editVendor('${id}')">Edit</button>
            <button class="btn btn-secondary" onclick="copyVendorLinkById('${id}')">Copy Link</button>
        `;
        container.appendChild(card);
    });
}

function calculateVendorBalance(vendorId) {
    const vendor = appData.vendors[vendorId];
    if (!vendor) return 0;
    
    let balance = vendor.prepayment;
    const vendorSales = Object.values(appData.sales).filter(sale => sale.vendorId === vendorId);
    vendorSales.forEach(sale => {
        balance -= sale.commission;
    });
    
    return balance;
}

async function loadVendorView(vendorId) {
    currentVendorId = vendorId;
    
    const vendorDoc = await db.collection('vendors').doc(vendorId).get();
    
    if (!vendorDoc.exists) {
        alert('Vendor not found');
        showView('loginView');
        return;
    }
    
    const vendor = { id: vendorDoc.id, ...vendorDoc.data() };
    appData.vendors[vendorId] = vendor;
    
    const salesSnap = await db.collection('sales').where('vendorId', '==', vendorId).get();
    salesSnap.forEach(doc => {
        appData.sales[doc.id] = { id: doc.id, ...doc.data() };
    });
    
    showView('vendorView');
    document.getElementById('vendorName').textContent = vendor.name;
    document.getElementById('vendorEmail').textContent = vendor.email;
    
    updateVendorBalance();
    renderSalesHistory();
    
    db.collection('sales').where('vendorId', '==', vendorId).onSnapshot(() => {
        db.collection('sales').where('vendorId', '==', vendorId).get().then(snap => {
            appData.sales = {};
            snap.forEach(doc => {
                appData.sales[doc.id] = { id: doc.id, ...doc.data() };
            });
            updateVendorBalance();
            renderSalesHistory();
        });
    });
}

function updateVendorBalance() {
    const balance = calculateVendorBalance(currentVendorId);
    const balanceEl = document.getElementById('vendorBalance');
    
    balanceEl.textContent = balance >= 0 ? `$${balance.toFixed(2)} Credit` : `Owes $${Math.abs(balance).toFixed(2)}`;
    
    balanceEl.className = 'balance-display';
    if (balance > 0) {
        balanceEl.classList.add('balance-positive');
    } else if (balance < 0) {
        balanceEl.classList.add('balance-negative');
    } else {
        balanceEl.classList.add('balance-zero');
    }
}

function renderSalesHistory() {
    const container = document.getElementById('salesHistoryList');
    const vendorSales = Object.entries(appData.sales)
        .filter(([id, sale]) => sale.vendorId === currentVendorId)
        .sort((a, b) => new Date(b[1].date) - new Date(a[1].date));
    
    if (vendorSales.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #718096;">No sales recorded yet</p>';
        return;
    }
    
    container.innerHTML = vendorSales.map(([id, sale]) => `
        <div class="sales-entry">
            <div>
                <div class="sales-date">${formatDate(sale.date)}</div>
                <div class="sales-amount">Gross: $${sale.grossSales.toFixed(2)}</div>
                <div class="sales-commission">Tally: $${sale.commission.toFixed(2)}</div>
            </div>
            ${isAdmin ? `<button class="btn btn-danger" style="width: auto; padding: 8px 16px; margin: 0;" onclick="deleteSale('${id}')">Delete</button>` : ''}
        </div>
    `).join('');
}

function showAddVendorModal() {
    document.getElementById('vendorLinkDisplay').classList.add('hidden');
    document.getElementById('addVendorModal').classList.add('active');
    
    document.getElementById('newVendorName').value = '';
    document.getElementById('newVendorEmail').value = '';
    document.getElementById('newVendorPrepayment').value = '';
    document.getElementById('newVendorCommission').value = '';
}

function showAddSalesModal() {
    document.getElementById('addSalesModal').classList.add('active');
    document.getElementById('salesDate').valueAsDate = new Date();
    document.getElementById('salesAmount').value = '';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

async function createVendor() {
    const btn = document.getElementById('createVendorBtn');
    btn.disabled = true;
    btn.textContent = 'Creating...';
    
    try {
        const name = document.getElementById('newVendorName').value.trim();
        const email = document.getElementById('newVendorEmail').value.trim();
        const prepayment = parseFloat(document.getElementById('newVendorPrepayment').value);
        const commissionRate = parseFloat(document.getElementById('newVendorCommission').value);
        
        if (!name || !email || isNaN(prepayment) || isNaN(commissionRate)) {
            alert('Please fill in all fields');
            return;
        }
        
        const vendorId = generateId();
        
        await db.collection('vendors').doc(vendorId).set({
            name,
            email,
            prepayment,
            commissionRate,
            createdAt: new Date().toISOString()
        });
        
        const link = `${window.location.origin}${window.location.pathname}?v=${vendorId}`;
        document.getElementById('generatedLink').textContent = link;
        document.getElementById('vendorLinkDisplay').classList.remove('hidden');
    } catch (error) {
        console.error('Error creating vendor:', error);
        alert('Error creating vendor: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Vendor';
    }
}

function editVendor(vendorId) {
    const vendor = appData.vendors[vendorId];
    if (!vendor) return;
    
    document.getElementById('editVendorId').value = vendorId;
    document.getElementById('editVendorName').value = vendor.name;
    document.getElementById('editVendorEmail').value = vendor.email;
    document.getElementById('editVendorPrepayment').value = vendor.prepayment;
    document.getElementById('editVendorCommission').value = vendor.commissionRate;
    
    document.getElementById('editVendorModal').classList.add('active');
}

async function updateVendor() {
    const vendorId = document.getElementById('editVendorId').value;
    
    await db.collection('vendors').doc(vendorId).update({
        name: document.getElementById('editVendorName').value.trim(),
        email: document.getElementById('editVendorEmail').value.trim(),
        prepayment: parseFloat(document.getElementById('editVendorPrepayment').value),
        commissionRate: parseFloat(document.getElementById('editVendorCommission').value)
    });
    
    closeModal('editVendorModal');
}

async function deleteVendor() {
    const vendorId = document.getElementById('editVendorId').value;
    
    if (!confirm('Are you sure you want to delete this vendor? This will also delete all their sales records.')) {
        return;
    }
    
    await db.collection('vendors').doc(vendorId).delete();
    
    const salesSnap = await db.collection('sales').where('vendorId', '==', vendorId).get();
    const deletePromises = salesSnap.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    closeModal('editVendorModal');
}

function copyVendorLinkById(vendorId) {
    const link = `${window.location.origin}${window.location.pathname}?v=${vendorId}`;
    navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
    });
}

function copyVendorLink() {
    const link = document.getElementById('generatedLink').textContent;
    navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
    });
}

async function addSales() {
    const btn = document.getElementById('addSalesBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    
    try {
        const date = document.getElementById('salesDate').value;
        const grossSales = parseFloat(document.getElementById('salesAmount').value);
        
        if (!date || isNaN(grossSales) || grossSales < 0) {
            alert('Please enter valid date and sales amount');
            return;
        }
        
        const vendor = appData.vendors[currentVendorId];
        const commission = (grossSales * vendor.commissionRate) / 100;
        
        const saleId = generateId();
        
        await db.collection('sales').doc(saleId).set({
            vendorId: currentVendorId,
            date,
            grossSales,
            commission,
            createdAt: new Date().toISOString()
        });
        
        closeModal('addSalesModal');
    } catch (error) {
        console.error('Error adding sales:', error);
        alert('Error adding sales: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Sales';
    }
}

async function deleteSale(saleId) {
    if (!confirm('Are you sure you want to delete this sales entry?')) {
        return;
    }
    
    await db.collection('sales').doc(saleId).delete();
}

async function exportData() {
    await loadAllData();
    
    const exportData = {
        exportDate: new Date().toISOString(),
        vendors: [],
        summary: {
            totalVendors: Object.keys(appData.vendors).length,
            totalSales: 0,
            totalTallies: 0
        }
    };
    
    Object.entries(appData.vendors).forEach(([id, vendor]) => {
        const balance = calculateVendorBalance(id);
        const vendorSales = Object.values(appData.sales).filter(sale => sale.vendorId === id);
        const totalSales = vendorSales.reduce((sum, sale) => sum + sale.grossSales, 0);
        const totalTallies = vendorSales.reduce((sum, sale) => sum + sale.commission, 0);
        
        exportData.vendors.push({
            name: vendor.name,
            email: vendor.email,
            prepayment: vendor.prepayment,
            tallyRate: vendor.commissionRate,
            currentBalance: balance,
            totalSales,
            totalTallies,
            salesCount: vendorSales.length,
            sales: vendorSales.map(sale => ({
                date: sale.date,
                grossSales: sale.grossSales,
                tally: sale.commission
            }))
        });
        
        exportData.summary.totalSales += totalSales;
        exportData.summary.totalTallies += totalTallies;
    });
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vendor-data-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function formatDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
    }
}
    </script>
</body>
</html>
